define(["backbone","text"],function(e){return e.Model.extend({defaults:{HEADER_TEXT:"The Insert Text Game!",DEFAULT_LANG:"en",WORDLISTS_DIRECTORY:"wordlists/",WORDLIST_EXTENSION:".txt",words:[],storedWords:[],wordId:0,currentLetterId:0,score:0,highscore:0,mode:"normal",lang:null,errors:0,startTime:0},INTEGER_FORMAT:/^[0-9]+$/,MODE_FORMAT:/^(long|short|normal)$/i,NUMBER_OF_WORDS:50,LANG_FORMAT:/^[a-z]{2}$/i,validate:function(e){if(!(e.words instanceof Array))return"gamemodel.words can only be a string array. Got "+typeof e.words+".";if(!(e.storedWords instanceof Array))return"gamemodel.words can only be a string array. Got "+typeof e.storedWords+".";if(typeof e.wordId!="number"||e.wordId<0||e.wordId>=e.words.length&&e.wordId!==0)return"gamemodel.wordId cannot be less than 0 or greater than the size of model.words. Got "+typeof e.wordId+(typeof e.wordId=="number"?" with value "+e.wordId.toString():"")+".";if(typeof e.currentLetterId!="number"||e.currentLetterId<0||e.words.length>0&&e.currentLetterId>e.words[e.wordId].length)return"gamemodel.currentLetterId cannot be less than 0 or greater than the length of the current model.word ("+e.words[e.wordId].length+"), got "+typeof e.currentLetterId+(typeof e.currentLetterId=="number"?" with value "+e.currentLetterId.toString():"")+".";if(typeof e.score!="number"||e.score<0)return"gamemodel.score must be a number and cannot possibly lower than 0, got "+typeof e.score+(typeof e.score=="number"?" with value "+e.score.toString():"")+".";if(typeof e.highscore!="number"||e.highscore<0)return"gamemodel.highscore must be a number and cannot possibly lower than 0, got "+typeof e.highscore+(typeof e.highscore=="number"?" with value "+e.highscore.toString():"")+".";if(typeof e.mode!="string"||!this.MODE_FORMAT.test(e.mode))return this.trigger("modeerror","Invalid mode!"),"gamemodel.error can only be in the right format!";e.lang===null&&(e.lang=e.DEFAULT_LANG);if(typeof e.lang!="string"||!this.LANG_FORMAT.test(e.lang))return"gamemodel.lang can only be null or contain only 2 letters, got "+typeof e.lang+(typeof e.lang=="string"?" with length"+e.lang.length.toString():"")+".";if(typeof e.errors!="number"||e.errors<0)return"gamemodel.error can only a number greater than or equal to 0, got "+typeof e.errors+(typeof e.errors=="number"?" with value "+e.errors.toString():"")+".";if(typeof e.startTime!="number"||e.startTime<0)return"gamemodel.startTime can only a number greater than or equal to 0, got "+typeof e.startTime+(typeof e.startTime=="number"?" with value "+e.startTime.toString():"")+"."},getCurrentWord:function(){return this.get("words")[this.get("wordId")]},getScore:function(){return this.get("score")},addToScore:function(e){this.set("score",this.get("score")+e,{validate:!0})},getHighscore:function(){return this.get("highscore")},guessChar:function(e){var t=this.get("currentLetterId"),n=0;return this.getCurrentWord()[t]!==e?!1:(t+=1,t>=this.getCurrentWord().length?(n=(new Date).getTime()-this.get("startTime"),this.addToScore(Math.floor(this.getCurrentWord().length*2/(this.get("errors")+Math.floor(n/1e3)+1))),this.deletePastWord(),this.pickWord()||(this.getScore()>this.getHighscore()?(this.trigger("beat-highscore","New high-score "+this.getScore().toString()+", congratulations!"),this.set("highscore",this.getScore(),{validate:!0})!==!1&&this.setStored("highscore",this.getScore())):this.trigger("beat-highscore","Not a new high-score "+this.getScore().toString()+", congratulations!"),this.trigger("finishedgame"))):this.set("currentLetterId",t,{validate:!0}),!0)},startNewGame:function(){var e=0,t=0,n=null,r=[];switch(this.get("mode")){case"long":this.set({words:this.get("storedWords").slice(-this.NUMBER_OF_WORDS),currentLetterId:0},{validate:!0});break;case"short":this.set({words:this.get("storedWords").slice(0,this.NUMBER_OF_WORDS),currentLetterId:0},{validate:!0});break;default:n=this.get("storedWords");for(e=0,t=this.NUMBER_OF_WORDS;e<t;e+=1)r.push(n.slice(Math.floor(Math.random()*n.length,1))[0]);this.set({words:r,currentLetterId:0},{validate:!0})}this.pickWord()},deletePastWord:function(){this.get("words").splice(this.get("wordId"),1)},pickWord:function(){var e=this.get("words").length;return e<1?(this.set({wordId:0,currentLetterId:0,startTime:0},{validate:!0}),!1):(this.set({wordId:Math.floor(Math.random()*e),currentLetterId:0,startTime:(new Date).getTime()},{validate:!0}),!0)},getWordList:function(){var e=this;require(["text!"+this.get("WORDLISTS_DIRECTORY")+this.get("lang")+this.get("WORDLIST_EXTENSION")+"!strip"],function(t){e.listenToOnce(e,"change:storedWords",function(){this.trigger("wordsLoaded")}),e.set("storedWords",$.grep(t.trimLeft().trimRight().split(/\r\n|\r|\n/g),e.cleanArrayFilter),{validate:!0})},function(){e.get("lang")===e.get("DEFAULT_LANG")?alert("Couldn't load the wordlist =(."):(e.set("lang",e.get("DEFAULT_LANG"),{validate:!0}),e.getWordList())})},cleanArrayFilter:function(e){return typeof e=="string"&&e.length>0},getStored:function(e){if(typeof e!="string"||e.length<1)throw"gamemodel setStored's parameter a_key must be a string greater than or equal to 1, got "+typeof e+".";return window.localStorage.getItem(e)},setStored:function(e,t){if(typeof e!="string"||e.length<1)throw"gamemodel setStored's parameter a_key must be a string greater than or equal to 1, got "+typeof e+".";return window.localStorage.setItem(e,t)},parseInteger:function(e){return typeof e!="string"||!this.INTEGER_FORMAT.test(e)?(console.error("gamemodel parseint's parameter a_value must be a string in the correct integer formatgot "+typeof e+(typeof e=="string"?"with value "+e+".":"")+"."),0):window.parseInt(e)},initialize:function(){var e=0,t=null;t=navigator.language||navigator.userLanguage,e=t.indexOf("-"),e>0?this.set("lang",t.substr(0,e),{validate:!0}):this.set("lang",t,{validate:!0}),this.set("highscore",this.parseInteger(this.getStored("highscore")),{validate:!0}),this.listenTo(this,"invalid",function(e,t){console.error(t)})}})});